<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bookm4rks</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css">
    <script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js"></script>
  </head>

  <body>

    <h1 id="header">hi</h1>

    <button id="refresh" class="button is-primary">Refresh</button>

    <div class="field">
      <div class="control">
        <input id="text" class="input is-primary" type="text" placeholder="Primary input">
      </div>
    </div>
    
    <div class="field">
      <div class="control">
        <div class="select is-primary">
          <select id="selaction">
            <option value="add">Add</option>
            <option value="delete">Delete</option>
            <option value="secret">Secret</option>
          </select>
        </div>
      </div>
    </div>
    
    <button id="send" class="button is-primary">Send</button>
    <div class="lds-ring" id="spinner" style="display: none"><div></div><div></div><div></div><div></div></div>

    <pre id="log"></pre>

    <ul id="list_new"></ul>
    <div id="list"></div>


    <script>
      let secret = localStorage.getItem('secret')
      if (secret === null) {
        document.getElementById('header').innerText = "Secret manquant"
      } else {
        document.getElementById('header').innerText = "Secret ok"
      }


      const spinner = document.getElementById('spinner')
      const input = document.getElementById('text')
      const btn = document.getElementById('send')
      const log = document.getElementById('log')

      let data
      try {
        data = JSON.parse(`{{values}}`)
      } catch (e) {
        btn.disabled = true;
        log.style.color = 'red'
        log.innerText = e.message
        throw e
      }
      
      const makeListElem = (line) => {
        return `
<li>
  <div class="notification is-primary">
    ${line.slug} - ${line.last} - lastUpdate: ${new Date(line.updatedAt).toLocaleString()}
  </div>
</li>`
      }
      
      const createTable = (lines) => {
        let b = `<table class="table">
  <thead>
    <tr>
      <th>Chap</th>
      <th>Name</th>
      <th>UpdatedAt</th>
    </tr>
  </thead>
  <tbody>
`;
        let ct = 0
       for (const line of lines) {
         const odd = ct % 2 === 0;
         b += `<tr class="${odd ? 'is-selected' : ''}">
            <th>${line.last}</th>
            <td>${line.slug}</td>
            <td>${new Date(line.updatedAt).toLocaleString()}</td>
            </tr>`;
         ct ++;
       }
        b += `</tbody></table>`;
        return b;
      }

      const updateList = () => {
        const list = document.getElementById('list')
//         const listCt = []
//         for (const line of data) {
//           listCt.push(makeListElem(line))
//         }
        
        list.innerHTML = createTable(data);
      }

      updateList()

      console.log(data)

      const getText = () => text.value !== "" ? text.value : '(empty)'
      btn.addEventListener('click', onClick)


      function onClick() {
        log.style.color = ''
        log.innerText = ''
        const text = getText()
        if (text === '(empty)') {
          log.style.color = 'red'
          log.innerText = 'No input given'
          return
        }
        spinner.style.display = ''
        btn.disabled = true

        //const [cmd, ..._rest] = text.split(' ')
        //const rest = _rest.join(' ')
        const cmd = selaction.value;
        const rest = text;

        handleCmd(cmd, rest).then(message => {
          log.innerText = JSON.stringify(message, 0, 2)}
        ).catch(e => {
          log.innerText = e.message
          log.style.color = 'red'
        }).then(() => {
          spinner.style.display = 'none'
          btn.disabled = false
        })
      }

      const wait = t => new Promise(r => setTimeout(r, t))

      async function handleCmd(cmd, payload) {
        if (cmd === 'secret') {
          localStorage.setItem('secret', payload);
          secret = payload;
          return 'secret=' + payload;
        }
        else if (cmd === 'add') {

          const res = await fetch('/api/bookmarks/', {
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json',
              'x-secret': secret
            },
            method: 'post',
            body: JSON.stringify({
              hello: 'world',
              slug: payload
            })
          })

          if (res.status >= 300) {
            throw new Error(res.statusText)
          }

          const body = await res.json()
          if (body.updateUi === 1) {
            data.push(body)
            updateList()
          }

          return body
        } else if (cmd === 'delete') {
          // await wait(2000)

          const res = await fetch('/api/bookmarks/', {
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json',
              'x-secret': secret
            },
            method: 'delete',
            body: JSON.stringify({
              slug: payload
            })
          })

          if (res.status >= 300) {
            throw new Error(res.statusText)
          }

          const body = await res.json()
          if (body.updateUi) {
            const newData = data.filter(x => x.slug !== body.slug)
            data = newData
            updateList()
          }

          return body
        } else {
          throw new Error('Command ' + cmd + ' not understood')
        }
      }

      document.getElementById('refresh').addEventListener('click', async () => {
        if (!secret) {
          log.innerText = 'Secret manquant';
          log.style.color = 'red'
          return;
        }
        spinner.style.display = ''
        btn.disabled = true
        try {
          const res = await fetch('/api/bookmarks/refresh', {
            headers: {
              'Accept': 'application/json',
              'Content-Type': 'application/json',
              'x-secret': secret
            },
            method: 'get'
          })
          if (res.status >= 300) {
            throw new Error(res.statusText)
          }

          const body = await res.json()
          if (body.updateUi === 1) {
            // location.reload()
            const data_new = []
            for (const item of body.slugs) {
              const x = data.find(x => x.slug === item.slug)
              if (x) {
                x.last = item.last
              }
              data_new.push(`<li><a href="${item.link}" class="has-text-success"> >>> ${item.slug}</a></li>`)
            }
            document.getElementById('list_new').innerHTML = data_new.join('')
            updateList()
          }
          log.innerText = JSON.stringify(body, 0, 2)
        } finally {
          spinner.style.display = 'none'
          btn.disabled = false
        }
      })

    </script>

    <style>
    .lds-ring {
  display: inline-block;
  position: relative;
  width: 64px;
  height: 64px;
}
.lds-ring div {
  box-sizing: border-box;
  display: block;
  position: absolute;
  width: 51px;
  height: 51px;
  margin: 6px;
  border: 6px solid #000;
  border-radius: 50%;
  animation: lds-ring 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
  border-color: #000 transparent transparent transparent;
}
.lds-ring div:nth-child(1) {
  animation-delay: -0.45s;
}
.lds-ring div:nth-child(2) {
  animation-delay: -0.3s;
}
.lds-ring div:nth-child(3) {
  animation-delay: -0.15s;
}
@keyframes lds-ring {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

    </style>
  </body>

</html>
